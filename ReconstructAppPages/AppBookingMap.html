<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Booking Map</title>
    <style>
        html, body, #map { height: 100%; margin: 0; padding: 0; }
        #countLabel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 10px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            font-size: 14px;
            font-family: calibri;
            font-weight: bold;
            z-index: 1000;
        }
        .legend {
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 10px;
            line-height: 18px;
            font-size: 14px;
            font-family: calibri;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }
        .legend i {
            width: 28px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.9;
            background-size: contain;
            background-repeat: no-repeat;
        }
    </style>

    <!-- Leaflet CSS/JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <!-- Marker Cluster CSS/JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.1/dist/leaflet.markercluster.js"></script>
</head>
<body>
    <div id="map"></div>
    <div id="countLabel">Jobs in View: 0</div>
  
    <script>
        var map = L.map('map').setView([-30.2963, 153.1135], 9);
        var markers = [];
        var markerClusterGroup = L.markerClusterGroup({
            maxClusterRadius: 35,
            spiderfyOnMaxZoom: true,
            zoomToBoundsOnClick: true
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data ¬© OpenStreetMap contributors'
        }).addTo(map);
		
		function getMarkerIcon(color, number) {
			color = (color || "").toLowerCase();
    		const validColors = ["violet", "blue", "red", "orange", "green", "grey", "black"];
    		if (!validColors.includes(color)) color = "yellow";

    		const showNumber = number !== null && number !== undefined && number.toString().trim() !== "";
    		const labelHtml = showNumber
        		? `<div style="
                		position: absolute; 
                		top: 4px; 
                		left: 0; 
                		right: 0;
                		text-align: center; 
                		font-size: 12px;
                		font-weight: bold; 
                		color: white;
                		background-color: rgb(121, 121, 121);
						padding: 0;
						border-radius: 9px;
						color: white;
            		">${number}</div>`
        		: "";

    		return L.divIcon({
        		html: `
            		<div style="
                		background: url('https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png') no-repeat center center;
                		background-size: contain;
                		width: 25px; 
                		height: 41px; 
                		position: relative;">
                		${labelHtml}
            		</div>`,
        		iconSize: [25, 41],
        		iconAnchor: [12, 41],
        		className: ''  // removes Leaflet's default styling
    		});
		}

        function loadJobs(data) {
            markerClusterGroup.clearLayers();
            markers.length = 0;

            for (let job of data) {
                let marker = L.marker([job.lat, job.lng], {
                    icon: getMarkerIcon(job.color, job.number)
                });

				let noteText = job.note || "";
				let plainNote = noteText
					.replace(/"/g, '&quot;')
					.replace(/<br\s*\/?>/gi, '\n');
				let noteHtml = plainNote.trim()
					? `<a href="#" title="${plainNote}" style="text-decoration:none; cursor: help;">‚ÑπÔ∏è</a>`
					: "";

				let noteText2 = job.note2 || "";
				let plainNote2 = noteText2
					.replace(/"/g, '&quot;')
					.replace(/<br\s*\/?>/gi, '\n');
				let noteHtml2 = plainNote2.trim()
					? `<a href="#" title="${plainNote2}" style="text-decoration:none; cursor: help;">üõà</a>`
					: "";
						
				let ardaystext = job.ardays ? `<br><i>AR Rec'd: ${job.ardays}</i>` : "";
						
				marker.bindPopup(`
				<strong>${job.jobref}</strong> ${noteHtml}${noteHtml2}
				<br><i>${job.address}</i>
				${ardaystext}
				`);

                marker.jobId = job.claimId; // Store the claim ID
				marker.jobNumber = parseInt(job.number);
                marker.addTo(markerClusterGroup);
                markers.push(marker);
            }

            map.addLayer(markerClusterGroup);

            if (markers.length === 1) {
                map.setView(markers[0].getLatLng(), 14);
            } else if (markers.length > 1) {
                let group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds());
            }

            updateJobCount();
        }

        function updateJobCount() {
            var count = 0;
            var bounds = map.getBounds();

            for (var i = 0; i < markers.length; i++) {
                if (bounds.contains(markers[i].getLatLng())) {
                    count++;
                }
            }

            document.getElementById("countLabel").innerText = "Jobs in View: " + count;
        }

        map.on('zoomend moveend', updateJobCount);

        // Add Legend
        var legend = L.control({ position: 'bottomright' });
        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'legend');
            div.innerHTML += "<strong>Legend:</strong><br>";

            const colorLabels = {
                violet: "Tender",
                blue: "Reinspect",
                red: "High Priority",
                orange: "Priority",
                green: "Normal",
            };

            for (let color in colorLabels) {
                div.innerHTML += `<i style="background-image: url('https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png');"></i> ${colorLabels[color]}<br>`;
            }

            return div;
        };
        legend.addTo(map);

        fetch('https://defaultf6ac5ab1555c4956ab5497cd053f74.fc.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/a672f832da2d45e386e6bef0d466901e/triggers/manual/paths/invoke/?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=7C1QQewMIyrfIh5Mc-zKsEGSYN8v-nvx_ZQ9HpZRS1M', {
		method: 'POST',
		headers: {
			'Content-Type': 'application/json'
		},
		body: '{}'  // Empty JSON payload
		})
		.then(res => {
		if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
		return res.json();
		})
		.then(data => {
		const items = data.value || data;
	
		if (!Array.isArray(items)) {
			console.error('Items is not an array!');
			return;
		}

		const jobs = items.map(item => ({
			lat: parseFloat(item.Latitude),
			lng: parseFloat(item.Longitude),
			color: item.Color ? item.Color.toLowerCase() : 'yellow',
			note: item.Note || '',
			note2: item.Note2 || '',
			ardays: item.ARDays || '',
			jobref: item.Title || '',
			address: item.Address || ''
		}));

		loadJobs(jobs);
		})
		.catch(err => console.error('Error loading SharePoint data:', err));
			
    </script>
</body>
</html>